---
apiVersion: generic-webhook/v1alpha1
kind: GenericWebhookConfig
webhookConfig:
  # Removes the command if it performs a "sleep"
  # It runs for all the containers in the pod
  - forEach: .spec.containers
    condition:
      contain:
        elements:
          getValue: .command
        value:
          const: sleep
    action:
      patch:
        op: remove
        path: command
      # No need to specify this, since we always
      # accept by default, unless there's some error
      accept: true
---
webhookConfig:
  - condition:
      and:
        # {key: tmachine.io/aws-instance-lifecycle} doesn't appear in preferredDuringSchedulingIgnoredDuringExecution
        - and:
            forEach: # forEachKey, forEachValue
              elements:
                getValue: .spec.affinity.nodeAffinity.preferredDuringSchedulingIgnoredDuringExecution
              op:
                not:
                  contain:
                    elements: { getValue: .preference.matchExpressions }
                    value:
                      const: { key: tmachine.io/aws-instance-lifecycle }
        # {key: tmachine.io/aws-instance-lifecycle} doesn't appear in requiredDuringSchedulingIgnoredDuringExecution
        - and:
            forEach:
              elements:
                getValue: .spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms
              op:
                not:
                  contain:
                    elements: { getValue: .matchExpressions }
                    value:
                      const: { key: tmachine.io/aws-instance-lifecycle }
    action:
      patch:
        op: add
        getValue: .spec.affinity.nodeAffinity.preferredDuringSchedulingIgnoredDuringExecution
        value:
          preference:
            matchExpressions:
              - key: tmachine.io/aws-instance-lifecycle
                operator: In
                values:
                  - spot
          weight: 1
---
webhookConfig:
  # Reject the Deployments that have a name different from the name in their pod template
  - condition:
      and:
        - equal:
            - getValue: .kind
            - const: Deployment
        - not:
            equal:
              - getValue: .metadata.name
              - getValue: .spec.template.metadata.name
    action:
      accept: false
---
getValue1: .spec.metadata

# On a forEach loop that iterates through all the containers in a pod
getValue2: $.spec.metadata
getValue3: -.spec.metadata
getValue4: .image
getValue5: $+.image
